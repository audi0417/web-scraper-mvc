<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台灣地圖測試頁面</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        .status-card {
            margin-bottom: 1rem;
        }
        .status-ok {
            border-left: 4px solid #28a745;
        }
        .status-error {
            border-left: 4px solid #dc3545;
        }
        .console-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 1rem;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h2><i class="bi bi-geo-alt"></i> 台灣地圖初始化測試</h2>
        
        <!-- 狀態檢查 -->
        <div class="row">
            <div class="col-md-6">
                <h4>依賴檢查</h4>
                <div id="dependency-status">
                    <!-- 動態填充 -->
                </div>
                
                <h4 class="mt-4">操作</h4>
                <button class="btn btn-primary me-2" onclick="runTest()">
                    <i class="bi bi-play"></i> 執行測試
                </button>
                <button class="btn btn-secondary me-2" onclick="clearConsole()">
                    <i class="bi bi-trash"></i> 清除日誌
                </button>
                <button class="btn btn-success" onclick="initMap()">
                    <i class="bi bi-map"></i> 初始化地圖
                </button>
            </div>
            
            <div class="col-md-6">
                <h4>控制台輸出</h4>
                <div id="console-output" class="console-output">
                    歡迎使用台灣地圖測試工具！點擊「執行測試」開始診斷。
                </div>
            </div>
        </div>
        
        <!-- 地圖容器 -->
        <div class="row mt-4">
            <div class="col-12">
                <h4>地圖測試區域</h4>
                <div id="map-test-container" style="height: 500px; border: 2px dashed #dee2e6; border-radius: 8px;">
                    <div class="d-flex align-items-center justify-content-center h-100">
                        <div class="text-center text-muted">
                            <i class="bi bi-map" style="font-size: 3rem;"></i>
                            <p>點擊「初始化地圖」來載入台灣地圖</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript 依賴 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- 專案檔案 -->
    <script src="js/pet_registration_data.js"></script>
    <script src="js/taiwan-map.js"></script>

    <script>
        // 重定向 console.log 到頁面
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function logToPage(message, type = 'log') {
            const output = document.getElementById('console-output');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'text-danger' : type === 'warn' ? 'text-warning' : 'text-dark';
            output.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            output.scrollTop = output.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            logToPage(args.join(' '), 'log');
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            logToPage('ERROR: ' + args.join(' '), 'error');
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            logToPage('WARN: ' + args.join(' '), 'warn');
        };

        let testMap = null;

        function checkDependencies() {
            const checks = [
                { name: 'Leaflet.js', check: () => typeof L !== 'undefined' },
                { name: 'Bootstrap', check: () => typeof bootstrap !== 'undefined' },
                { name: 'TaiwanInteractiveMap', check: () => typeof TaiwanInteractiveMap !== 'undefined' },
                { name: 'petRegistrationData', check: () => typeof petRegistrationData !== 'undefined' }
            ];
            
            const container = document.getElementById('dependency-status');
            container.innerHTML = '';
            
            checks.forEach(item => {
                const isOk = item.check();
                const card = document.createElement('div');
                card.className = `card status-card ${isOk ? 'status-ok' : 'status-error'}`;
                card.innerHTML = `
                    <div class="card-body p-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>${item.name}</span>
                            <span class="badge ${isOk ? 'bg-success' : 'bg-danger'}">
                                ${isOk ? '✓ OK' : '✗ 失敗'}
                            </span>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
            
            return checks.every(item => item.check());
        }

        function runTest() {
            console.log('開始執行依賴檢查...');
            const allOk = checkDependencies();
            
            if (allOk) {
                console.log('✓ 所有依賴都正常載入');
                
                // 測試數據處理
                if (typeof petRegistrationData !== 'undefined') {
                    const itemCount = petRegistrationData.items ? petRegistrationData.items.length : 0;
                    console.log(`✓ 寵物登記數據載入成功，共 ${itemCount} 筆資料`);
                }
                
                // 測試地圖容器
                const container = document.getElementById('map-test-container');
                if (container) {
                    console.log('✓ 地圖容器元素存在');
                } else {
                    console.error('✗ 找不到地圖容器元素');
                }
                
            } else {
                console.error('✗ 部分依賴載入失敗，請檢查網路連線和檔案路徑');
            }
        }

        function clearConsole() {
            document.getElementById('console-output').innerHTML = '';
        }

        function initMap() {
            try {
                console.log('開始初始化台灣地圖...');
                
                if (!checkDependencies()) {
                    console.error('依賴檢查失敗，無法初始化地圖');
                    return;
                }
                
                // 清空容器
                const container = document.getElementById('map-test-container');
                container.innerHTML = '<div class="text-center p-3">正在載入地圖...</div>';
                
                // 初始化地圖
                testMap = new TaiwanInteractiveMap('map-test-container');
                testMap.initialize(petRegistrationData).then(() => {
                    console.log('✓ 台灣地圖初始化成功！');
                }).catch(error => {
                    console.error('✗ 地圖初始化失敗:', error);
                    container.innerHTML = `
                        <div class="alert alert-danger">
                            <h6>地圖初始化失敗</h6>
                            <p>錯誤訊息: ${error.message}</p>
                            <button class="btn btn-outline-danger btn-sm" onclick="initMap()">重試</button>
                        </div>
                    `;
                });
                
            } catch (error) {
                console.error('初始化過程中發生異常:', error);
            }
        }

        // 頁面載入完成後自動檢查依賴
        document.addEventListener('DOMContentLoaded', function() {
            console.log('台灣地圖測試頁面載入完成');
            setTimeout(() => {
                checkDependencies();
            }, 500);
        });
    </script>
</body>
</html>